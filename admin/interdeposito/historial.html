<!DOCTYPE html>
<html lang="es">

<head>

    <head>
        <title>formulainterdepo</title>
        <link rel="icon" type="image/x-icon" href="/img/logoGiroofi.png" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Roboto:wght@700&display=swap"
            rel="stylesheet">
        <link rel="stylesheet" href="/style/index.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        <link rel="stylesheet" href="/style/formulariointerde.css">
    </head>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo-container">
            <img src="/img/logoGiroofi.png" alt="Logo Izquierda" class="logo">
        </div>
        <div class="title-container">
            <h1>PUNTO GIRO</h1>
            <h2>CONTROL DE STOCK</h2>
        </div>
    </header>
    <nav>
        <ul>
            <li>
                <a href="/admin/index.html">
                    <i class="fas fa-home"></i>>
                </a>
            </li>
            <li><a href="/admin/interdeposito/interdepoadmin.html">interdeposito ></a></li>
            <li><a href="">formulario</a></li>
        </ul>
    </nav>
    <h1>Historial de Interdeposito</h1>

    <table id="historialTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Telefono</th>
                <th>Origen</th>
                <th>Destino</th>
                <th>Fecha de Creación</th>
                <th>Usuario</th>
                <th>Estado</th>
                <th>Insumos</th>
            </tr>
        </thead>
        <tbody>
            <!-- Los registros se insertarán aquí mediante JavaScript -->
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            obtenerHistorial()
            cerrarSesion();
            validarSesion();
        });

        function cerrarSesion() {
            let cerrarSesion = document.querySelector(".logOut")
            cerrarSesion.addEventListener("click", function () {
                localStorage.clear()
                window.location.href = "../auth/login.html"
            })
        }

        function validarSesion() {
            let sesion = localStorage.getItem("isLoggedIn")
            let userSession = localStorage.getItem("userSession")
            if (!sesion || !userSession) {
                window.location.href = "../auth/login.html"
            }
        }
        // Función para obtener los datos del historial
        async function obtenerHistorial() {
            try {
                const user_id = localStorage.getItem("userSession");
                const response = await fetch(`http://localhost:3000/api-giro/interdeposito/?user_id=${user_id}`);
                const data = await response.json();
                console.log(data);
        
                if (data.success && data.result_data.length > 0) {
                    const historial = data.result_data;
                    const tbody = document.getElementById('historialTable').getElementsByTagName('tbody')[0];
                    tbody.innerHTML = '';
        
                    historial.forEach((registro, index) => {
                        // Crear la fila principal del interdeposito
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = registro.id;
                        row.insertCell(1).textContent = registro.telefono;
                        row.insertCell(2).textContent = registro.origen;
                        row.insertCell(3).textContent = registro.destino;
                        row.insertCell(4).textContent = new Date(registro.fecha_creacion).toLocaleDateString();
                        row.insertCell(5).textContent = registro.nombre_usuario;
                        row.insertCell(6).textContent = registro.estado;
                        const insumosCell = row.insertCell(7);
                        if(registro.estado == "pendiente"){
                            const verInsumosBtn = document.createElement('a');
                            verInsumosBtn.textContent = 'Gestionar remito';
                            verInsumosBtn.href = "/admin/interdeposito/remito.html"
                            insumosCell.appendChild(verInsumosBtn);
                        }else{
                            const verInsumosBtn = document.createElement('a');
                            verInsumosBtn.textContent = 'Ver remito';
                            verInsumosBtn.href = "#"
                            verInsumosBtn.onclick = () => toggleInsumos(index);
                            insumosCell.appendChild(verInsumosBtn);
                            
                            // Crear una fila oculta para los insumos
                            const insumosRow = tbody.insertRow();
                            insumosRow.style.display = 'none';
                            insumosRow.setAttribute('id', `insumosRow-${index}`);
                            const insumosCellFull = insumosRow.insertCell(0);
                            insumosCellFull.colSpan = 7; // Ocupa todas las columnas
                            insumosCellFull.innerHTML = generarTablaInsumos(registro.insumos);
                        }
                    });
                } else {
                    const tbody = document.getElementById('historialTable').getElementsByTagName('tbody')[0];
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay registros disponibles.</td></tr>';
                }
            } catch (error) {
                console.error('Error al obtener los datos:', error);
            }
        }
        
        // Función para generar la tabla de insumos
        function generarTablaInsumos(insumos) {
            let insumosHTML = `
                <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                    <thead>
                        <tr style="background-color:#f4f4f4;">
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Cantidad</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            insumos.forEach(insumo => {
                insumosHTML += `
                    <tr>
                        <td>${insumo.id}</td>
                        <td>${insumo.nombre_insumo}</td>
                        <td>${insumo.cantidad}</td>
                        <td>${insumo.estado}</td>
                    </tr>
                `;
            });
            insumosHTML += '</tbody></table>';
            return insumosHTML;
        }
        
        // Función para mostrar/ocultar la fila de insumos
        function toggleInsumos(index) {
            const insumosRow = document.getElementById(`insumosRow-${index}`);
            if (insumosRow.style.display === 'none') {
                insumosRow.style.display = 'table-row';
            } else {
                insumosRow.style.display = 'none';
            }
        }

    </script>

</body>

</html>
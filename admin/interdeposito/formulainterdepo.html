<!DOCTYPE html>
<html lang="en">

<head>
    <title>formulainterdepo</title>
    <link rel="icon" type="image/x-icon" href="/img/logoGiroofi.png" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Roboto:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/style/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/style/formulariointerde.css">
</head>

<body>
    <header>
        <div class="logo-container">
            <img src="/img/logoGiroofi.png" alt="Logo Izquierda" class="logo">
        </div>
        <div class="title-container">
            <h1>PUNTO GIRO</h1>
            <h2>CONTROL DE STOCK</h2>
        </div>
        <div>
            <button type="button" class="logOut">cerrar sesion</button>
          </div>
    </header>
    <nav>
        <ul>
            <li>
                <a href="/admin/index.html">
                    <i class="fas fa-home"></i>>
                </a>
            </li>
            <li><a href="/admin/interdeposito/interdepoadmin.html">interdeposito ></a></li>
            <li><a href="">formulario</a></li>
        </ul>
    </nav>
    <br>
    <br>
    <h2>Formulario de Interdepósito</h2>
    <form id="interdepositoForm" method="POST">
        <!-- Origen -->
        <label for="origen">Origen:</label>
        <select id="origen" name="origen" required>
        </select>

        <!-- Destino -->
        <label for="destino">Destino:</label>
        <select id="destino" name="destino" required>
            <option value="" disabled selected>Selecciona una opción</option>
            <option value="2">Chacarita</option>
            <option value="3">Oficina</option>
            <option value="4">Predio Ferial</option>
            <option value="5">Valle Chico</option>
        </select>

        <label for="">Telefono: </label>
        <input type="number" id="telefono">

        <!-- Botones Confirmar y Cancelar -->
        <div class="button-container">
            <button type="button" class="confirmar" onclick="mostrarInsumos()">Agregar Insumos</button>
            <button type="reset" class="cancelar">Cancelar</button>
        </div>

        <!-- Campos para Añadir Insumos (Ocultos hasta Confirmar) -->
        <div id="insumoContainer" style="display: none; margin-top: 20px;">
            <h3>Insumos</h3>
            <div class="button-row">
                <input type="text" id="buscarInsumo" list="insumos" placeholder="Buscar insumo">
                <datalist id="insumos"></datalist>
                <input type="number" id="cantidadInsumo" placeholder="Cantidad" min="1">
                <button type="button" class="añadir" onclick="añadirInsumo()">Añadir</button>
            </div>

            <!-- Tabla de Insumos -->
            <table id="insumosTable" hidden>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se agregarán los insumos -->
                </tbody>
            </table>

            <!-- Botones Enviar y Cancelar para los detalles del interdepósito -->
            <div class="button-container">
                <button type="button" class="confirmar" onclick="guardarInterdeposito()">Enviar</button>
                <button type="button" class="cancelar-detalle" onclick="cancelarInsumos()">Cancelar</button>
            </div>
        </div>
    </form>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Función para mostrar los campos de insumo
        document.addEventListener("DOMContentLoaded", () => {
            cargarInsumos()
            validarSesion();
            cargarPuntoDeControl();
            cerrarSesion();
        })

        function cerrarSesion() {
            let cerrarSesion = document.querySelector(".logOut")
            cerrarSesion.addEventListener("click", function () {
                localStorage.clear()
                window.location.href = "../auth/login.html"
            })
        }

        function validarSesion() {
            let sesion = localStorage.getItem("isLoggedIn")
            let userSession = localStorage.getItem("userSession")
            if (!sesion || !userSession) {
                window.location.href = "../auth/login.html"
            }
        }

        async function cargarPuntoDeControl(){
            try {
                const user_id = localStorage.getItem("userSession")
                const response = await fetch(`http://localhost:3000/api-giro/punto_de_control/${user_id}`);

                const punto_de_control = await response.json();

                // Asumiendo que `insumos` es una lista de objetos con una propiedad "nombre" o similar
                const origenSelect = document.getElementById('origen');
                const option= document.createElement("option")
                option.value = punto_de_control.result_data[0].id;
                option.textContent = punto_de_control.result_data[0].punto_de_control;
                origenSelect.appendChild(option)

            } catch (error) {
                console.error('Error al cargar punto de control:', error);
            }
        }
        async function guardarInterdeposito() {
            try {
                const origen = document.getElementById("origen").value
                const destino = document.getElementById("destino").value
                const telefono = document.getElementById("telefono").value
                const usuario_id = localStorage.getItem("userSession")
                const trs = document.getElementById('insumosTable').querySelector('tbody').querySelectorAll('tr')

                insumos = Array.from(trs).map((insumo) => {
                    return {
                        id: insumo.children[0].textContent,
                        nombre_insumo: insumo.children[1].textContent,
                        cantidad: insumo.children[2].textContent
                    }
                })

                const interdepositoData = {
                    origen,
                    destino,
                    telefono,
                    usuario_id,
                    insumos
                }
                const response = await fetch('http://localhost:3000/api-giro/interdeposito/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(interdepositoData)
                })
                const result = await response.json();
                console.log(result)
                if (result.success == true) {
                    Swal.fire({
                        icon: 'success',
                        title: result.result_message,
                        text: 'El interdeposito ha sido creado con éxito',
                    }).then(() => {
                        window.location.href = "historial.html";
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: result.result_message,
                        text: 'El interdeposito no se pudo crear',
                    });
                }
            } catch (error) {
                console.error('Error al intentar guardar interdeposito:', error);
            }
        }

        async function cargarInsumos() {
            try {
                const user_id = localStorage.getItem("userSession")
                const response = await fetch(
                    `http://localhost:3000/api-giro/insumo/?user_id=${user_id}`); // Reemplaza con la URL de tu endpoint
                const insumos = await response.json();

                // Asumiendo que `insumos` es una lista de objetos con una propiedad "nombre" o similar
                const dataList = document.getElementById('insumos');
                dataList.innerHTML = ''; // Limpiar opciones previas

                insumos.result_data.forEach(insumo => {
                    const option = document.createElement('option');
                    option.value = insumo.nombre_insumo;
                    option.setAttribute("data-id", insumo.id)
                    dataList.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar insumos:', error);
            }
        }

        function mostrarInsumos() {
            document.getElementById('insumoContainer').style.display = 'block';
        }

        // Función para añadir insumo a la tabla
        function añadirInsumo() {
            const insumoNombre = document.getElementById('buscarInsumo');
            const cantidad = document.getElementById('cantidadInsumo').value;
            if (!insumoNombre || !cantidad) {
                alert("Por favor, ingrese el nombre y la cantidad del insumo.");
                return;
            }
            document.getElementById('insumosTable').hidden = false;
            const table = document.getElementById('insumosTable').querySelector('tbody');
            const row = document.createElement('tr');
            const dataList = document.getElementById("insumos")
            const option = Array.from(dataList.options).find(opt => opt.value === insumoNombre.value);
            console.log(option)
            row.innerHTML = `
                <tr>
                    <th>${option.getAttribute('data-id')}</th>
                    <th>${insumoNombre.value}</th>
                    <th>${cantidad}</th>
                </tr>
            `

            // Añadir la fila a la tabla
            table.appendChild(row);

            // Limpiar campos de insumo
            document.getElementById('buscarInsumo').value = '';
            document.getElementById('cantidadInsumo').value = '';
        }

        // Función para cancelar y ocultar el formulario de insumos
        function cancelarInsumos() {
            document.getElementById('insumoContainer').style.display = 'none';
            document.getElementById('insumosTable').querySelector('tbody').innerHTML = '';
        }
    </script>

    <br>
    <br>
    <br>
    <br>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 Punto Giro. Todos los derechos reservados.</p>
            <!-- <p>Diseñado por [Tu Nombre]</p> -->
        </div>
    </footer>
</body>

</html>